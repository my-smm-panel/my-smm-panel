<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGPRO - SECURE SMM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #050810; color: white; font-family: sans-serif; }
        .glass { background: rgba(22, 29, 47, 0.8); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .neo-input { background: #0a0f1d; border: 1px solid #1e293b; color: white; border-radius: 12px; }
    </style>
</head>
<body class="p-4">

    <div id="authBox" class="fixed inset-0 bg-black z-[999] flex items-center justify-center">
        <div class="glass p-10 text-center">
            <h2 class="text-3xl font-black mb-6 italic text-blue-500">DGPRO</h2>
            <button onclick="handleGoogle()" class="bg-white text-black px-8 py-3 rounded-xl font-bold">Login with Google</button>
        </div>
    </div>

    <div id="dashboard" class="hidden max-w-md mx-auto space-y-6">
        <div class="glass p-6 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold italic text-blue-500">DGPRO</h1>
                <button onclick="document.getElementById('addMoneyModal').classList.remove('hidden')" class="text-[10px] bg-blue-600/20 text-blue-400 px-2 py-1 rounded mt-1 font-bold">+ ADD MONEY</button>
            </div>
            <div class="text-right">
                <p id="uBal" class="text-2xl font-black text-green-400">â‚¹0.00</p>
                <button onclick="logout()" class="text-[10px] text-red-500 font-bold uppercase">Sign Out</button>
            </div>
        </div>

        <div class="glass p-6 space-y-4">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">New Order</h2>
            <select id="svcSel" class="w-full p-4 neo-input text-xs"></select>
            <input id="orderLink" type="text" placeholder="Service Link" class="w-full p-4 neo-input text-xs">
            <input id="orderQty" type="number" placeholder="Quantity" class="w-full p-4 neo-input text-xs">
            <button onclick="placeOrder()" class="w-full bg-blue-600 py-4 rounded-xl font-black hover:bg-blue-700 transition">PLACE ORDER</button>
        </div>

        <div id="addMoneyModal" class="hidden fixed inset-0 bg-black/90 z-[1000] flex items-center justify-center p-6">
            <div class="glass p-8 w-full max-w-sm space-y-4">
                <h2 class="text-xl font-bold text-center italic">REDEEM <span class="text-blue-500">GIFT CARD</span></h2>
                <p class="text-[10px] text-slate-400 text-center">Enter your DG Gift Card code to add balance</p>
                <input id="redeemCode" type="text" placeholder="Enter Card Code" class="w-full p-4 neo-input text-center font-bold uppercase">
                <button onclick="redeemGift()" class="w-full bg-green-600 py-4 rounded-xl font-black">REDEEM NOW</button>
                <button onclick="document.getElementById('addMoneyModal').classList.add('hidden')" class="w-full text-slate-500 text-xs font-bold">Cancel</button>
            </div>
        </div>

        <div id="adminPanel" class="hidden glass border-2 border-red-900/30 p-6 space-y-4">
            <h2 class="text-red-500 font-black text-center text-xs uppercase tracking-tighter">Master Admin Control</h2>
            <div class="bg-black/40 p-4 rounded-xl space-y-3">
                <p class="text-[10px] font-bold text-slate-400">CREATE DG GIFT CARD</p>
                <input id="giftCode" type="text" placeholder="CODE100" class="w-full p-3 neo-input text-xs font-bold uppercase">
                <input id="giftVal" type="number" placeholder="Amount â‚¹" class="w-full p-3 neo-input text-xs font-bold">
                <button onclick="adminGenGift()" class="w-full bg-red-600 py-3 rounded-xl font-bold text-xs">GENERATE CARD</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update, increment, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCbOQZjrqbfr6r23MFNlDZavyB9AChK_XM", //
            authDomain: "smspanel-76488.firebaseapp.com",
            databaseURL: "https://smspanel-76488-default-rtdb.firebaseio.com",
            projectId: "smspanel-76488",
            storageBucket: "smspanel-76488.firebasestorage.app",
            messagingSenderId: "478520093402",
            appId: "1:478520093402:web:bf976787e46af3017b13e3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        const BACKEND = "https://dg-backend-jhqa.onrender.com"; //

        let uRef, myBal = 0, userUID = "";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUID = user.uid;
                document.getElementById('authBox').style.display = 'none';
                document.getElementById('dashboard').classList.remove('hidden');
                
                if(user.email === "stanix579@gmail.com") { //
                    document.getElementById('adminPanel').classList.remove('hidden');
                }

                uRef = ref(db, 'users/' + user.uid);
                onValue(uRef, (s) => {
                    myBal = s.val() ? s.val().balance : 0;
                    document.getElementById('uBal').innerText = "â‚¹" + myBal.toFixed(2);
                    if(!s.val()) set(uRef, { balance: 0, email: user.email });
                });

                fetch(`${BACKEND}/services`).then(r => r.json()).then(data => {
                    document.getElementById('svcSel').innerHTML = data.map(s => `<option value="${s.service}">${s.name} - â‚¹${(s.rate*1.25).toFixed(2)}</option>`).join('');
                });
            }
        });

        // ðŸŽ GIFT CARD REDEEM (User Side)
        window.redeemGift = async () => {
            const code = document.getElementById('redeemCode').value.toUpperCase();
            if(!code) return alert("Enter Code!");

            const giftRef = ref(db, `gifts/${code}`);
            const snapshot = await get(giftRef);

            if (snapshot.exists() && snapshot.val().active === true) {
                const amount = snapshot.val().amount;
                // Add balance and deactivate card in one go
                await update(uRef, { balance: increment(amount) });
                await update(giftRef, { active: false, redeemedBy: userUID });
                alert(`Success! â‚¹${amount} added to wallet.`);
                document.getElementById('addMoneyModal').classList.add('hidden');
                document.getElementById('redeemCode').value = "";
            } else {
                alert("Invalid or Expired Gift Card!");
            }
        };

        // ðŸ”’ ADMIN GENERATE GIFT (Admin Only)
        window.adminGenGift = async () => {
            const code = document.getElementById('giftCode').value.toUpperCase();
            const val = parseFloat(document.getElementById('giftVal').value);
            if(!code || !val) return alert("Fill all details!");

            await set(ref(db, `gifts/${code}`), {
                amount: val,
                active: true,
                createdAt: new Date().toISOString()
            });
            alert("DG Gift Card Created Successfully!");
            document.getElementById('giftCode').value = "";
            document.getElementById('giftVal').value = "";
        };

        window.placeOrder = async () => {
            // Check balance first
            if(myBal <= 0) return alert("Insufficient Balance! Redeem a Gift Card first.");
            
            const res = await fetch(`${BACKEND}/place-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    service: document.getElementById('svcSel').value,
                    link: document.getElementById('orderLink').value,
                    quantity: document.getElementById('orderQty').value,
                    token: "DGPRO_ULTRA_SECURE_X99"
                })
            });
            const data = await res.json();
            if(data.success) alert("Order Placed Successfully!");
            else alert("Error: " + data.error);
        };

        window.handleGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
